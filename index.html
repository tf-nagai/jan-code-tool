<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JANã‚³ãƒ¼ãƒ‰è¿½åŠ ãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            background: #f0f2ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #e8ebff;
            border-color: #764ba2;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 18px;
        }

        .upload-hint {
            color: #999;
            font-size: 14px;
        }

        input[type="file"] {
            display: none;
        }

        .file-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .file-name {
            color: #333;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .file-size {
            color: #666;
            font-size: 14px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress-container {
            display: none;
            margin-bottom: 20px;
        }

        .progress-container.show {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        .result {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .result.show {
            display: block;
        }

        .result.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .features {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }

        .features h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .feature-list {
            list-style: none;
        }

        .feature-list li {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
            padding-left: 25px;
            position: relative;
        }

        .feature-list li:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: #667eea;
            font-weight: bold;
        }

        .footer {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¦ JANã‚³ãƒ¼ãƒ‰è¿½åŠ ãƒ„ãƒ¼ãƒ«</h1>
        <p class="subtitle">åœ¨åº«CSVãƒ•ã‚¡ã‚¤ãƒ«ã«JANã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•è¿½åŠ ã—ã¾ã™</p>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“„</div>
            <div class="upload-text">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã¾ãŸã¯ãƒ‰ãƒ­ãƒƒãƒ—</div>
            <div class="upload-hint">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã€ã¾ãŸã¯ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
        </div>

        <input type="file" id="fileInput" accept=".csv">

        <div class="file-info" id="fileInfo">
            <div class="file-name" id="fileName"></div>
            <div class="file-size" id="fileSize"></div>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">å‡¦ç†ä¸­...</div>
        </div>

        <div class="result" id="result"></div>

        <button class="btn btn-primary" id="processBtn" disabled>JANã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¦ä¿å­˜</button>

        <div class="features">
            <h3>âœ¨ æ©Ÿèƒ½</h3>
            <ul class="feature-list">
                <li>ãƒ‡ãƒ¼ã‚¿ã¯å¤–éƒ¨ã«é€ä¿¡ã•ã‚Œã¾ã›ã‚“</li>
                <li>å•†å“IDã‹ã‚‰è‡ªå‹•ã§JANã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</li>
                <li>å…ƒã®CSVã¯ãã®ã¾ã¾ã€æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</li>
                <li>å¤§é‡ãƒ‡ãƒ¼ã‚¿ã«ã‚‚å¯¾å¿œ</li>
            </ul>
        </div>

        <div class="footer">
            Â© 2025 JANã‚³ãƒ¼ãƒ‰è¿½åŠ ãƒ„ãƒ¼ãƒ« v1.0
        </div>
    </div>

    <script>
        // è¦ç´ ã®å–å¾—
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const processBtn = document.getElementById('processBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const result = document.getElementById('result');

        let selectedFile = null;

        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
        fileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        function handleFile(file) {
            if (!file) return;

            // CSVãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
            if (!file.name.endsWith('.csv')) {
                showResult('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™', true);
                return;
            }

            selectedFile = file;
            fileName.textContent = 'ğŸ“„ ' + file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.classList.add('show');
            processBtn.disabled = false;
            result.classList.remove('show');
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        // å‡¦ç†ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        processBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            processBtn.disabled = true;
            progressContainer.classList.add('show');
            result.classList.remove('show');

            try {
                const csvText = await readFileAsText(selectedFile);
                const processedCSV = await processCSV(csvText);
                downloadCSV(processedCSV, selectedFile.name);
            } catch (error) {
                showResult('ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
            } finally {
                processBtn.disabled = false;
                progressContainer.classList.remove('show');
            }
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦èª­ã¿è¾¼ã‚€
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                reader.readAsText(file, 'Shift_JIS'); // æ—¥æœ¬èªCSVã«å¯¾å¿œ
            });
        }

        // CSVå‡¦ç†
        async function processCSV(csvText) {
            updateProgress(10, 'CSVã‚’è§£æä¸­...');

            // è¡Œã«åˆ†å‰²
            const lines = csvText.split(/\r?\n/);
            
            if (lines.length < 2) {
                throw new Error('ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼+ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ï¼‰');
            }

            updateProgress(20, 'å•†å“IDåˆ—ã‚’æ¤œç´¢ä¸­...');

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è§£æ
            const headerFields = parseCSVLine(lines[0]);
            const productIDCol = findProductIDColumn(headerFields);
            
            if (productIDCol === -1) {
                throw new Error('å•†å“IDåˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆ1åˆ—ç›®ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä½¿ç”¨ã—ã¾ã™ï¼‰');
            }

            updateProgress(30, 'JANã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆä¸­...');

            // æ–°ã—ã„ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½œæˆ
            const newHeader = [...headerFields, 'JANã‚³ãƒ¼ãƒ‰'];
            const newLines = [newHeader];

            let processedCount = 0;
            let errorCount = 0;

            // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’å‡¦ç†
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line.length === 0) continue;

                const fields = parseCSVLine(line);
                
                if (fields.length > productIDCol) {
                    const productID = fields[productIDCol].trim();
                    
                    if (productID && !isNaN(productID)) {
                        const janCode = generateJANCode(parseInt(productID));
                        newLines.push([...fields, janCode]);
                        processedCount++;
                    } else {
                        newLines.push([...fields, 'ã‚¨ãƒ©ãƒ¼:å•†å“IDä¸æ­£']);
                        errorCount++;
                    }
                } else {
                    newLines.push([...fields, 'ã‚¨ãƒ©ãƒ¼:åˆ—ä¸è¶³']);
                    errorCount++;
                }

                // é€²æ—æ›´æ–°
                if (i % 100 === 0) {
                    const progress = 30 + ((i / lines.length) * 60);
                    updateProgress(progress, `å‡¦ç†ä¸­... ${i} / ${lines.length}`);
                    await sleep(1); // UIã®æ›´æ–°ã‚’å¾…ã¤
                }
            }

            updateProgress(95, 'CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­...');

            // CSVæ–‡å­—åˆ—ã«å¤‰æ›
            const resultCSV = newLines.map(fields => joinCSVLine(fields)).join('\r\n');

            updateProgress(100, 'å®Œäº†ï¼');

            showResult(`âœ“ å‡¦ç†å®Œäº†: ${processedCount}ä»¶ã®JANã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã—ãŸ` + 
                       (errorCount > 0 ? `\nâš  ã‚¨ãƒ©ãƒ¼: ${errorCount}ä»¶` : ''), false);

            return resultCSV;
        }

        // CSVè¡Œã‚’è§£æï¼ˆã‚«ãƒ³ãƒã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œï¼‰
        function parseCSVLine(line) {
            const fields = [];
            let currentField = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        currentField += '"';
                        i++; // Skip next quote
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    fields.push(currentField);
                    currentField = '';
                } else {
                    currentField += char;
                }
            }

            fields.push(currentField);
            return fields;
        }

        // CSVè¡Œã‚’çµåˆ
        function joinCSVLine(fields) {
            return fields.map(field => {
                const str = String(field);
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return '"' + str.replace(/"/g, '""') + '"';
                }
                return str;
            }).join(',');
        }

        // å•†å“IDåˆ—ã‚’æ¤œç´¢
        function findProductIDColumn(headerFields) {
            for (let i = 0; i < headerFields.length; i++) {
                if (headerFields[i].includes('å•†å“ID')) {
                    return i;
                }
            }
            return 0; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯1åˆ—ç›®
        }

        // JANã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
        function generateJANCode(productID) {
            // å•†å“IDã‚’8æ¡ã«å¤‰æ›ï¼ˆå·¦å´ã‚’0ã§åŸ‹ã‚ã‚‹ï¼‰
            const productIDStr = String(productID).padStart(8, '0');
            
            // ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã€Œ2000ã€ã‚’è¿½åŠ ã—ã¦12æ¡ã«ã™ã‚‹
            const jan12 = '2000' + productIDStr;
            
            // ãƒã‚§ãƒƒã‚¯ãƒ‡ã‚¸ãƒƒãƒˆã‚’è¨ˆç®—
            const checkDigit = calculateCheckDigit(jan12);
            
            // 13æ¡ã®JANã‚³ãƒ¼ãƒ‰ã‚’è¿”ã™
            return jan12 + checkDigit;
        }

        // ãƒã‚§ãƒƒã‚¯ãƒ‡ã‚¸ãƒƒãƒˆè¨ˆç®—ï¼ˆJAN-13æ¨™æº–ï¼‰
        function calculateCheckDigit(jan12) {
            let oddSum = 0;
            let evenSum = 0;

            // å³ã‹ã‚‰æ•°ãˆã¦å¥‡æ•°ä½ç½®ã¨å¶æ•°ä½ç½®ã®åˆè¨ˆã‚’è¨ˆç®—
            for (let i = 0; i < 12; i++) {
                const digit = parseInt(jan12[11 - i]);
                if (i % 2 === 0) {
                    oddSum += digit;
                } else {
                    evenSum += digit;
                }
            }

            // (å¥‡æ•°ä½ç½®ã®åˆè¨ˆ Ã— 3) + å¶æ•°ä½ç½®ã®åˆè¨ˆ
            const total = (oddSum * 3) + evenSum;

            // 10ã§å‰²ã£ãŸä½™ã‚Š
            const remainder = total % 10;

            // ãƒã‚§ãƒƒã‚¯ãƒ‡ã‚¸ãƒƒãƒˆã‚’è¨ˆç®—
            return remainder === 0 ? 0 : 10 - remainder;
        }

        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadCSV(csvText, originalFileName) {
            const newFileName = originalFileName.replace('.csv', '_JANã‚³ãƒ¼ãƒ‰ä»˜ã.csv');
            
            // BOMã‚’è¿½åŠ ã—ã¦Excelã§æ­£ã—ãé–‹ã‘ã‚‹ã‚ˆã†ã«ã™ã‚‹
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csvText], { type: 'text/csv;charset=utf-8;' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = newFileName;
            link.click();
            
            URL.revokeObjectURL(link.href);
        }

        // é€²æ—æ›´æ–°
        function updateProgress(percent, text) {
            progressFill.style.width = percent + '%';
            progressText.textContent = text;
        }

        // çµæœè¡¨ç¤º
        function showResult(message, isError) {
            result.textContent = message;
            result.classList.toggle('error', isError);
            result.classList.add('show');
        }

        // ã‚¹ãƒªãƒ¼ãƒ—é–¢æ•°
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
